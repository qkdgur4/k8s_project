// frontend/views/home.pug (ìµœì¢… ì™„ì„±ë³¸ - Auth ì¶”ê°€)

doctype html
html
  head
    meta(charset='utf-8')
    title í•œì…ë¡œê·¸
    meta(name='viewport', content='width=device-width, initial-scale=1')
    link(rel='stylesheet', href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css')
    link(rel='stylesheet', href='/css/style.css')
  body
    - const allTags = [{emoji: 'ğŸ‘¥', label: 'ë‹¨ì²´ì„'}, {emoji: 'ğŸª‘', label: 'ì…ì‹'}, {emoji: 'ğŸ§‘â€ğŸ³', label: 'íŠ¹ë³„í•œë©”ë‰´'}, {emoji: 'ğŸ›‹ï¸', label: 'ì¸í…Œë¦¬ì–´'}, {emoji: 'ğŸŒ¿', label: 'ì‹ ì„ í•œ'}, {emoji: 'ğŸ’•', label: 'ë°ì´íŠ¸'}, {emoji: 'ğŸ‘€', label: 'ë„“ì€'}, {emoji: 'ğŸ‘¥', label: 'íšŒì‹'}, {emoji: 'ğŸ—£ï¸', label: 'ëŒ€í™”'}, {emoji: 'ğŸ™', label: 'í˜¼ë°¥'}, {emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', label: 'ê°€ì¡±ëª¨ì„'}, {emoji: 'âœ¨', label: 'ë¶„ìœ„ê¸°ì¢‹ì€'}, {emoji: 'ğŸ†•', label: 'ìƒˆë¡œì˜¤í”ˆ'}]

    #header-section.header.bg-light.mb-0
      .container
        //- ğŸŸ¢ 1. ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ UI ì¶”ê°€
        .d-flex.justify-content-between.align-items-center
          div
            h1: a(href='/', class='text-dark text-decoration-none') í•œì…ë¡œê·¸ğŸ½
            p.text-muted.mb-0 ì‘ì€ í•œì…ì—ë„ ì´ì•¼ê¸°ê°€ ë‹´ê²¨ìš” ğŸ²
          div
            //- ë¹„ë¡œê·¸ì¸ ì‹œ
            #auth-links
              button.btn.btn-outline-primary.btn-sm.mr-2#login-btn ë¡œê·¸ì¸
              button.btn.btn-outline-secondary.btn-sm#register-btn íšŒì›ê°€ì…
            //- ë¡œê·¸ì¸ ì‹œ
            #user-info(style="display: none;")
              span#welcome-msg.text-muted.mr-3
              button.btn.btn-danger.btn-sm#logout-btn ë¡œê·¸ì•„ì›ƒ

    //- ğŸŸ¢ 2. ë¡œê·¸ì¸ í¼ (ìˆ¨ê²¨ì§)
    #login-form-section.container.mb-5(style="display: none;")
      h3.mb-4.text-primary ğŸ”’ ë¡œê·¸ì¸
      form#login-form
        .form-group
          label(for='login-username') ì•„ì´ë””
          input#login-username.form-control(type='text' name='username' required)
        .form-group
          label(for='login-password') ë¹„ë°€ë²ˆí˜¸
          input#login-password.form-control(type='password' name='password' required)
        button.btn.btn-primary.btn-block(type='submit') ë¡œê·¸ì¸
        button.btn.btn-secondary.btn-block(type='button')#cancel-login-btn ì·¨ì†Œ

    //- ğŸŸ¢ 3. íšŒì›ê°€ì… í¼ (ìˆ¨ê²¨ì§)
    #register-form-section.container.mb-5(style="display: none;")
      h3.mb-4.text-primary ğŸ‘¤ íšŒì›ê°€ì…
      form#register-form
        .form-group
          label(for='register-username') ì•„ì´ë””
          input#register-username.form-control(type='text' name='username' required)
        .form-group
          label(for='register-password') ë¹„ë°€ë²ˆí˜¸
          input#register-password.form-control(type='password' name='password' required)
        button.btn.btn-success.btn-block(type='submit') íšŒì›ê°€ì…
        button.btn.btn-secondary.btn-block(type='button')#cancel-register-btn ì·¨ì†Œ

    //- ğŸŸ¢ 4. ìƒˆ ë¦¬ë·° í¼ (ìˆ¨ê²¨ì§)
    #form-section.container.mb-5(style="display: none;")
      h3.mb-4.text-primary âœï¸ ìƒˆ ë¦¬ë·° ì‘ì„±
      form#new-review-form
        //- ... (í¼ ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼)
        .form-group
          label(for='name') ì´ë¦„
          input#name.form-control(type='text' name='name' placeholder='ìµëª…ë„ ê°€ëŠ¥í•´ìš”' required)
        .form-group
          label(for='store') ê°€ê²Œëª…
          input#store.form-control(type='text' name='store' placeholder='ë°©ë¬¸í•œ ìŒì‹ì  ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”' required)
        .form-group
          label(for='category') ìŒì‹ ë¶„ë¥˜
          select#category.form-control(name='category' required)
            option(value='') -- ì„ íƒ --
            option(value='í•œì‹') í•œì‹
            option(value='ì¤‘ì‹') ì¤‘ì‹
            option(value='ì¼ì‹') ì¼ì‹
            option(value='ì–‘ì‹') ì–‘ì‹
            option(value='ë¶„ì‹') ë¶„ì‹
            option(value='ê¸°íƒ€') ê¸°íƒ€
        .form-group
          label(for='menu') ë¨¹ì€ ìŒì‹
          input#menu.form-control(type='text' name='menu' placeholder='ì˜ˆ: ê¹€ì¹˜ì°Œê°œ, í¬ë¦¼íŒŒìŠ¤íƒ€ ë“±' required)
        .form-group
          label(for='taste') ë§› í‰ì 
          select#taste.form-control(name='taste' required)
            option(value='') -- ì„ íƒ --
            option(value='5') â˜…â˜…â˜…â˜…â˜…
            option(value='4') â˜…â˜…â˜…â˜…â˜†
            option(value='3') â˜…â˜…â˜…â˜†â˜†
            option(value='2') â˜…â˜…â˜†â˜†â˜†
            option(value='1') â˜…â˜†â˜†â˜†â˜†
        .form-group
          label íƒœê·¸ (ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒ)
          .tag-selector.border.p-3.rounded
            each tag in allTags
              .form-check.form-check-inline
                input.form-check-input(type='checkbox', name='tags', id=`tag-${tag.label}`, value=tag.label)
                label.form-check-label(for=`tag-${tag.label}`)= `${tag.emoji} ${tag.label}`
        .form-group
          label(for='memo') ì¶”ê°€ ë©”ëª¨
          textarea#memo.form-control(name='memo' rows='4' placeholder='ìœ„ìƒ ìƒíƒœ, ìœ„ì¹˜, ê±¸ë¦¬ëŠ” ì‹œê°„ ë“±ì„ ì ì–´ì£¼ì„¸ìš”')
        .form-group
          label(for='recommend') ì¶”ì²œ ì—¬ë¶€
          select#recommend.form-control(name='recommend' required)
            option(value='') -- ì„ íƒ --
            option(value='yes') ì¶”ì²œí•´ìš” ğŸ‘
            option(value='no') ì•„ì‰¬ì›Œìš” ğŸ‘
        button.btn.btn-success.btn-block(type='submit') ì‘ì„± ì™„ë£Œ
        button.btn.btn-secondary.btn-block(type='button')#hide-form-btn ì·¨ì†Œ

    //- ğŸŸ¢ 5. ë©”ì¸ ì½˜í…ì¸  (í•„í„° + ëª©ë¡)
    #page-content
      .container.mb-5
        .d-flex.justify-content-between.align-items-start.mb-4
          div
            h5.text-muted ğŸ± ìŒì‹ ì¢…ë¥˜
            - const categories = ['ì „ì²´', 'í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ê¸°íƒ€']
            each cat in categories
              a(href=`/?category=${cat}`, class=`btn ${currentCategory === cat ? 'btn-primary' : 'btn-outline-secondary'} mr-2 mb-2`)= cat
          div.ml-4(style="min-width: 200px;")
            h5.text-muted âœ¨ ë¶„ìœ„ê¸° íƒœê·¸
            select#tag-filter.form-control.form-control-sm
              option(value='') -- íƒœê·¸ë¡œ ë¶„ë¥˜ --
              each tag in allTags
                option(value=tag.label, selected=(currentTag === tag.label))= `${tag.emoji} ${tag.label}`
          div.ml-auto.pl-4
            button.btn.btn-primary.btn-sm#show-form-btn(style="white-space: nowrap;") âœï¸ ìƒˆ ë¦¬ë·° ì‘ì„±

      .container-fluid.posts.mt-5
        include list.pug
        if totalPages > 1
          nav.d-flex.justify-content-center.mt-4
            ul.pagination
              li.page-item(class=(currentPage == 1 ? 'disabled' : ''))
                a.page-link(href=`/?page=${currentPage - 1}${baseQuery}`) Previous
              - for (let i = 1; i <= totalPages; i++)
                li.page-item(class=(i == currentPage ? 'active' : ''))
                  a.page-link(href=`/?page=${i}${baseQuery}`)= i
              li.page-item(class=(currentPage == totalPages ? 'disabled' : ''))
                a.page-link(href=`/?page=${currentPage + 1}${baseQuery}`) Next

    //- ğŸŸ¢ 6. ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ (Auth)
    script.
      document.addEventListener('DOMContentLoaded', () => {
        // ì„¹ì…˜/ë²„íŠ¼ ì„ íƒ
        const header = document.getElementById('header-section');
        const pageContent = document.getElementById('page-content');
        const formSection = document.getElementById('form-section');
        const loginSection = document.getElementById('login-form-section');
        const registerSection = document.getElementById('register-form-section');
        const authLinks = document.getElementById('auth-links');
        const userInfo = document.getElementById('user-info');
        const welcomeMsg = document.getElementById('welcome-msg');
        
        // í¼/ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        const showButton = document.getElementById('show-form-btn');
        const hideButton = document.getElementById('hide-form-btn');
        const loginButton = document.getElementById('login-btn');
        const registerButton = document.getElementById('register-btn');
        const logoutButton = document.getElementById('logout-btn');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const cancelRegisterBtn = document.getElementById('cancel-register-btn');
        const tagFilter = document.getElementById('tag-filter');

        // ëª¨ë“  ì„¹ì…˜ì„ ìˆ¨ê¸°ëŠ” í—¬í¼ í•¨ìˆ˜
        function hideAllSections() {
          formSection.style.display = 'none';
          loginSection.style.display = 'none';
          registerSection.style.display = 'none';
          header.style.display = 'block';
          pageContent.style.display = 'block';
        }

        // 1. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
        function checkLoginState() {
          const token = localStorage.getItem('token');
          const username = localStorage.getItem('username');
          if (token && username) {
            authLinks.style.display = 'none';
            userInfo.style.display = 'block';
            welcomeMsg.textContent = `ğŸ‘‹ ${username}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
          } else {
            authLinks.style.display = 'block';
            userInfo.style.display = 'none';
            welcomeMsg.textContent = '';
          }
          // URL ê²½ë¡œì— ë”°ë¼ í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          updateVisibility();
        }

        // 2. í¼/ì„¹ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateVisibility() {
          const path = window.location.pathname;
          if (path === '/reviews/new') {
            hideAllSections();
            formSection.style.display = 'block';
          } else if (path === '/login') {
            hideAllSections();
            loginSection.style.display = 'block';
          } else if (path === '/register') {
            hideAllSections();
            registerSection.style.display = 'block';
          } else {
            hideAllSections(); // '/' (ë©”ì¸ í˜ì´ì§€)
          }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        if (showButton) {
          showButton.addEventListener('click', () => {
            if (!localStorage.getItem('token')) {
              alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
              history.pushState(null, '', '/login');
              updateVisibility();
            } else {
              history.pushState(null, '', '/reviews/new');
              updateVisibility();
            }
          });
        }
        if (hideButton) {
          hideButton.addEventListener('click', () => {
            history.pushState(null, '', '/');
            updateVisibility();
          });
        }
        if (loginButton) {
          loginButton.addEventListener('click', () => {
            history.pushState(null, '', '/login');
            updateVisibility();
          });
        }
        if (registerButton) {
          registerButton.addEventListener('click', () => {
            history.pushState(null, '', '/register');
            updateVisibility();
          });
        }
        if (logoutButton) {
          logoutButton.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
          });
        }
        if (cancelLoginBtn) {
          cancelLoginBtn.addEventListener('click', () => {
            history.pushState(null, '', '/');
            updateVisibility();
          });
        }
        if (cancelRegisterBtn) {
          cancelRegisterBtn.addEventListener('click', () => {
            history.pushState(null, '', '/');
            updateVisibility();
          });
        }
        if (tagFilter) {
          tagFilter.addEventListener('change', (e) => {
            const selectedTag = e.target.value;
            window.location.href = selectedTag ? `/?tag=${selectedTag}` : '/';
          });
        }
        
        window.addEventListener('popstate', updateVisibility);
        checkLoginState(); // í˜ì´ì§€ ì²« ë¡œë“œ ì‹œ ì‹¤í–‰
      });

    //- 7. main.jsëŠ” ì´ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ 'ì•„ë˜'ì— ë‘¡ë‹ˆë‹¤.
    script(src='/main.js')