// frontend/views/edit.pug (ìµœì¢… ì™„ì„±ë³¸ - ì˜¤ì§ í¼ë§Œ)

doctype html
html
  head
    meta(charset="utf-8")
    title ë¦¬ë·° ìˆ˜ì •í•˜ê¸°
    link(rel="stylesheet", href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css")
    link(rel="stylesheet", href="/css/style.css")
  body
    //- ğŸŸ¢ í—¤ë”, ëª©ë¡ ë“± ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œë¥¼ ì œê±°í•˜ê³  í¼ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
    .container.mt-5.mb-5
      h2 ğŸ“ ë¦¬ë·° ìˆ˜ì •í•˜ê¸°
      
      form#edit-form
        input(type="hidden", name="id", value=review._id)

        .form-group
          label(for="name") ì‘ì„±ì
          input#name.form-control(type="text", name="name", value=review.name, required)
        
        .form-group
          label(for="store") ê°€ê²Œëª…
          input#store.form-control(type="text", name="store", value=review.store, required)
        
        .form-group
          label(for="category") ì¹´í…Œê³ ë¦¬
          select#category.form-control(name='category' required)
            - const categories = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ê¸°íƒ€']
            each cat in categories
              option(value=cat, selected=(review.category === cat))= cat
        
        .form-group
          label(for="menu") ë©”ë‰´
          input#menu.form-control(type="text", name="menu", value=review.menu, required)
        
        .form-group
          label(for="taste") ë§› í‰ì 
          select#taste.form-control(name='taste' required)
            - const ratings = { '5': 'â˜…â˜…â˜…â˜…â˜…', '4': 'â˜…â˜…â˜…â˜…â˜†', '3': 'â˜…â˜…â˜…â˜†â˜†', '2': 'â˜…â˜…â˜†â˜†â˜†', '1': 'â˜…â˜†â˜†â˜†â˜†' }
            each label, val in ratings
              option(value=val, selected=(review.taste === val))= label
        
        .form-group
          label(for="mood") ë¶„ìœ„ê¸°
          input#mood.form-control(type="text", name="mood", value=review.mood, required)

        .form-group
          label(for="memo") ë©”ëª¨
          textarea#memo.form-control(name="memo", rows='4')= review.memo

        .form-group
          label(for="recommend") ì¶”ì²œ ì—¬ë¶€
          select#recommend.form-control(name="recommend" required)
            option(value='') -- ì„ íƒ --
            option(value="yes", selected=(review.recommend === 'yes')) ì¶”ì²œí•´ìš” ğŸ‘
            option(value="no", selected=(review.recommend === 'no')) ì•„ì‰¬ì›Œìš” ğŸ‘

        button.btn.btn-success.btn-block(type="submit") ìˆ˜ì • ì™„ë£Œ
        button.btn.btn-secondary.btn-block(type="button", onclick="window.close()") ë‹«ê¸°

  script.
    document.getElementById('edit-form').addEventListener('submit', async (event) => {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      const reviewId = data.id;

      try {
        const response = await fetch(`/api/reviews/${reviewId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
          window.opener?.location.reload(); 
          window.close(); 
        } else {
          const errorData = await response.json();
          alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (errorData.error || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'));
        }
      } catch (err) {
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
      }
    });