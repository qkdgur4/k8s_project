// frontend/views/edit.pug (최종 완성본 - 오직 폼만)

doctype html
html
  head
    meta(charset="utf-8")
    title 리뷰 수정하기
    link(rel="stylesheet", href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css")
    link(rel="stylesheet", href="/css/style.css")
  body
    //- 🟢 헤더, 목록 등 다른 모든 요소를 제거하고 폼만 남깁니다.
    .container.mt-5.mb-5
      h2 📝 리뷰 수정하기
      
      form#edit-form
        input(type="hidden", name="id", value=review._id)

        .form-group
          label(for="name") 작성자
          input#name.form-control(type="text", name="name", value=review.name, required)
        
        .form-group
          label(for="store") 가게명
          input#store.form-control(type="text", name="store", value=review.store, required)
        
        .form-group
          label(for="category") 카테고리
          select#category.form-control(name='category' required)
            - const categories = ['한식', '중식', '일식', '양식', '분식', '기타']
            each cat in categories
              option(value=cat, selected=(review.category === cat))= cat
        
        .form-group
          label(for="menu") 메뉴
          input#menu.form-control(type="text", name="menu", value=review.menu, required)
        
        .form-group
          label(for="taste") 맛 평점
          select#taste.form-control(name='taste' required)
            - const ratings = { '5': '★★★★★', '4': '★★★★☆', '3': '★★★☆☆', '2': '★★☆☆☆', '1': '★☆☆☆☆' }
            each label, val in ratings
              option(value=val, selected=(review.taste === val))= label
        
        .form-group
          label(for="mood") 분위기
          input#mood.form-control(type="text", name="mood", value=review.mood, required)

        .form-group
          label(for="memo") 메모
          textarea#memo.form-control(name="memo", rows='4')= review.memo

        .form-group
          label(for="recommend") 추천 여부
          select#recommend.form-control(name="recommend" required)
            option(value='') -- 선택 --
            option(value="yes", selected=(review.recommend === 'yes')) 추천해요 👍
            option(value="no", selected=(review.recommend === 'no')) 아쉬워요 👎

        button.btn.btn-success.btn-block(type="submit") 수정 완료
        button.btn.btn-secondary.btn-block(type="button", onclick="window.close()") 닫기

  script.
    document.getElementById('edit-form').addEventListener('submit', async (event) => {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      const reviewId = data.id;

      try {
        const response = await fetch(`/api/reviews/${reviewId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          alert('수정되었습니다!');
          window.opener?.location.reload(); 
          window.close(); 
        } else {
          const errorData = await response.json();
          alert('수정 실패: ' + (errorData.error || '서버 응답 오류'));
        }
      } catch (err) {
        alert('수정 중 오류 발생: ' + err.message);
      }
    });