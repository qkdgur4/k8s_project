// frontend/views/edit.pug (ìµœì¢… ì™„ì„±ë³¸ - Tags ì—…ê·¸ë ˆì´ë“œ)

doctype html
html
  head
    meta(charset="utf-8")
    title ë¦¬ë·° ìˆ˜ì •í•˜ê¸°
    link(rel="stylesheet", href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css")
    link(rel="stylesheet", href="/css/style.css")
  body
    .container.mt-5.mb-5
      h2 ğŸ“ ë¦¬ë·° ìˆ˜ì •í•˜ê¸°
      
      form#edit-form
        input(type="hidden", name="id", value=review._id)

        //- ... (name, store, category, menu, taste í•„ë“œëŠ” ì´ì „ê³¼ ë™ì¼)
        .form-group
          label(for="name") ì‘ì„±ì
          input#name.form-control(type="text", name="name", value=review.name, required)
        .form-group
          label(for="store") ê°€ê²Œëª…
          input#store.form-control(type="text", name="store", value=review.store, required)
        .form-group
          label(for="category") ì¹´í…Œê³ ë¦¬
          select#category.form-control(name='category' required)
            - const categories = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ê¸°íƒ€']
            each cat in categories
              option(value=cat, selected=(review.category === cat))= cat
        .form-group
          label(for="menu") ë©”ë‰´
          input#menu.form-control(type="text", name="menu", value=review.menu, required)
        .form-group
          label(for="taste") ë§› í‰ì 
          select#taste.form-control(name='taste' required)
            - const ratings = { '5': 'â˜…â˜…â˜…â˜…â˜…', '4': 'â˜…â˜…â˜…â˜…â˜†', '3': 'â˜…â˜…â˜…â˜†â˜†', '2': 'â˜…â˜…â˜†â˜†â˜†', '1': 'â˜…â˜†â˜†â˜†â˜†' }
            each label, val in ratings
              option(value=val, selected=(review.taste === val))= label

        //- ğŸŸ¢ "ë¶„ìœ„ê¸°" ì…ë ¥ì°½ì„ "íƒœê·¸" ì²´í¬ë°•ìŠ¤ë¡œ ë³€ê²½
        .form-group
          label íƒœê·¸ (ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒ)
          .tag-selector.border.p-3.rounded
            - const tags = [{emoji: 'ğŸ‘¥', label: 'ë‹¨ì²´ì„'}, {emoji: 'ğŸª‘', label: 'ì…ì‹'}, {emoji: 'ğŸ§‘â€ğŸ³', label: 'íŠ¹ë³„í•œë©”ë‰´'}, {emoji: 'ğŸ›‹ï¸', label: 'ì¸í…Œë¦¬ì–´'}, {emoji: 'ğŸŒ¿', label: 'ì‹ ì„ í•œ'}, {emoji: 'ğŸ’•', label: 'ë°ì´íŠ¸'}, {emoji: 'ğŸ‘€', label: 'ë„“ì€'}, {emoji: 'ğŸ‘¥', label: 'íšŒì‹'}, {emoji: 'ğŸ—£ï¸', label: 'ëŒ€í™”'}, {emoji: 'ğŸ™', label: 'í˜¼ë°¥'}, {emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', label: 'ê°€ì¡±ëª¨ì„'}, {emoji: 'âœ¨', label: 'ë¶„ìœ„ê¸°ì¢‹ì€'}, {emoji: 'ğŸ†•', label: 'ìƒˆë¡œì˜¤í”ˆ'}]
            each tag in tags
              .form-check.form-check-inline
                //- ğŸŸ¢ name="tags", value=tag.label
                //- ğŸŸ¢ ğŸŸ¢ ğŸŸ¢ 'checked' ì†ì„± ì¶”ê°€: review.tagsì— ì´ íƒœê·¸ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì²´í¬ë¨
                input.form-check-input(
                  type='checkbox', 
                  name='tags', 
                  id=`tag-${tag.label}`, 
                  value=tag.label,
                  checked=(review.tags && review.tags.includes(tag.label))
                )
                label.form-check-label(for=`tag-${tag.label}`)= `${tag.emoji} ${tag.label}`

        .form-group
          label(for='memo') ë©”ëª¨
          textarea#memo.form-control(name="memo", rows='4')= review.memo

        .form-group
          label(for='recommend') ì¶”ì²œ ì—¬ë¶€
          select#recommend.form-control(name="recommend" required)
            option(value='') -- ì„ íƒ --
            option(value="yes", selected=(review.recommend === 'yes')) ì¶”ì²œí•´ìš” ğŸ‘
            option(value="no", selected=(review.recommend === 'no')) ì•„ì‰¬ì›Œìš” ğŸ‘

        button.btn.btn-success.btn-block(type="submit") ìˆ˜ì • ì™„ë£Œ
        button.btn.btn-secondary.btn-block(type="button", onclick="window.close()") ë‹«ê¸°

  //- ğŸŸ¢ 'submit' ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •
  script.
    document.getElementById('edit-form').addEventListener('submit', async (event) => {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);
      
      // ğŸŸ¢ 1. 'tags'ë§Œ ë°°ì—´ë¡œ ë”°ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.
      const tags = formData.getAll('tags');

      // ğŸŸ¢ 2. 'tags'ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë°ì´í„°ë¥¼ ê°ì²´ë¡œ ë§Œë“­ë‹ˆë‹¤.
      const data = Object.fromEntries(formData.entries());

      // ğŸŸ¢ 3. ê°ì²´ì— 'tags' ë°°ì—´ì„ ë‹¤ì‹œ ì‚½ì…í•©ë‹ˆë‹¤.
      data.tags = tags;
      const reviewId = data.id;

      // ğŸŸ¢ 4. í”„ë¡ íŠ¸ì—”ë“œ ìœ íš¨ì„± ê²€ì‚¬ (íƒœê·¸ ìµœì†Œ 1ê°œ)
      if (tags.length === 0) {
        alert('íƒœê·¸ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return; // ì„œë²„ë¡œ ì „ì†¡í•˜ì§€ ì•Šê³  ì¤‘ë‹¨
      }

      try {
        const response = await fetch(`/api/reviews/${reviewId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data), // 'tags' ë°°ì—´ì´ í¬í•¨ëœ ê°ì²´ë¥¼ ì „ì†¡
        });

        if (response.ok) {
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
          window.opener?.location.reload(); 
          window.close(); 
        } else {
          const errorData = await response.json();
          alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (errorData.error || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'));
        }
      } catch (err) {
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
      }
    });